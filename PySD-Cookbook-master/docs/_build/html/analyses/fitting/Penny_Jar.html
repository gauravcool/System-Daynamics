

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Estimating penny population parameters &mdash; PySD-Cookbook 0.1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="PySD-Cookbook 0.1.0 documentation" href="../../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> PySD-Cookbook</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index_getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Introduction.html">Introduction to the PySD Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Installing.html">Installation and Setup of Python and PySD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Python.html">Getting Started with Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Notebook.html">Using the Jupyter Notebook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Git_and_Github.html">Working with <code class="docutils literal"><span class="pre">git</span></code> and github</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Hello_World_Teacup.html">Hello World: The Teacup Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../data_handling/index_data_handling.html">Data Handling</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../data_handling/pandas.html">Data handling with Pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_handling/Writing_to_Database.html">Saving Simulation Results to a Database</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/index_visualization.html">Visualization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../visualization/matplotlib.html">Basic Visualization with <code class="docutils literal"><span class="pre">matplotlib</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../visualization/other_visualization_libraries.html">Other Visualization Packages in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../visualization/phase_portraits.html">Phase Portraits</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index_fitting.html">Model Fitting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="Fitting_with_Optimization.html">Fitting a model&#8217;s parameters with run-at-a-time optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="Step_at_a_time_optimization.html">Step-at-a-time optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="Massively_Parallel_Fitting.html">Parallel Model Fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="MCMC_for_fitting_models.html">Fitting a model with Markov Chain Monte Carlo</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../geo/index_geo.html">Geographic Analyses</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../geo/Doing_more_with_spatialdata_multi_regional_SIR_Model.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geo/Doing_more_with_spatialdata_multi_regional_SIR_Model.html#using-sd-to-understand-the-sd-fever">Using SD to understand the SD Fever</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geo/Doing_more_with_spatialdata_multi_regional_SIR_Model.html#modify-parameter-values">Modify parameter values</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geo/Doing_more_with_spatialdata_multi_regional_SIR_Model.html#change-model-settings">Change Model settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geo/Doing_more_with_spatialdata_multi_regional_SIR_Model.html#geographical-information">Geographical Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geo/Doing_more_with_spatialdata_multi_regional_SIR_Model.html#run-the-model-for-each-country">Run the model for each country</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geo/Doing_more_with_spatialdata_multi_regional_SIR_Model.html#transpose-simulation-results-for-plotting">Transpose simulation results for plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geo/Doing_more_with_spatialdata_multi_regional_SIR_Model.html#comparative-analysis">Comparative Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geo/Doing_more_with_spatialdata_multi_regional_SIR_Model.html#analysis-of-results">Analysis of results</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geo/Doing_more_with_spatialdata_multi_regional_SIR_Model.html#how-spatial-analysis-leads-to-insight">How Spatial Analysis Leads to Insight</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geo/Doing_more_with_spatialdata_multi_regional_SIR_Model.html#plotting-simulation-results-on-map-with-ipywidgets">Plotting simulation results on map with Ipywidgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geo/Exploring_models_across_geographic_scales.html">Using SD models to understand the differences between population measures at varying levels of geographic disagregation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../surrogating_functions/index_surrogate.html">Surrogating Functions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../surrogating_functions/Surrogating_with_regression.html">Surrogating a function with a machine learning estimator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../surrogating_functions/Surrogating_with_regression_Workbook.html">Surrogating a function with a machine learning estimator</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../realtime/index_realtime.html">Realtime Data Incorporation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../realtime/Nth_Order_Delay_Demo.html">Nth Order Delay Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../realtime/Twitter_Stream.html">Feeding models with realtime streaming data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../workflow/index_workflow.html">Model Development Workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../workflow/Unit_Testing.html">Unit Testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../data/index_data.html">Data Used in this Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../data/Baby_Names/Baby_Name_Data.html">Baby Name Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data/Census/US_Census_Data_Collection.html">Collecting US decennial census data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data/Climate/sources.html">Carbon Data Sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data/Defects_Synthetic/Manufacturing_Defects_Synthetic.html">Manufacturing Defects Synthetic Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data/Ebola/Ebola_Data_Loader.html">Ebola Data Loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data/Emails/Email_Data_Formatter.html">Parse gmail <code class="docutils literal"><span class="pre">.mbox</span></code> file</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../future.html">Chapters to be Written</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../endnotes.html">End Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../endnotes.html#for-instruction">For instruction</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">PySD-Cookbook</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
    <li>Estimating penny population parameters</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../../_sources/analyses/fitting/Penny_Jar.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="estimating-penny-population-parameters">
<h1>Estimating penny population parameters<a class="headerlink" href="#estimating-penny-population-parameters" title="Permalink to this headline">¶</a></h1>
<p>In this example we&#8217;ll use a System Dynamics model to estimate the total
number of pennies in circulation, based upon the number of pennies
produced in a given year, and the number of pennies in a coin jar.</p>
<p>We start with a simple aging model for pennies, in essence a second
order delay. Pennies are minted each year, and go into a stock of &#8216;post
production&#8217; pennies that are distributed to banks, etc. After this they
go into general circulation, from which they are eventually lost.</p>
<p>In this analysis we&#8217;ll try and infer the parameters for entry into
circulation and loss based upon the number of pennies produced in each
year, and a random sample of pennies taken from circulation over a four
year period. An interesting component of this analysis is that it
requires a whole suite of models (one for each model year) but these
models don&#8217;t interact with one another except through the sampling and
statistical analysis we perform.</p>
<p>In this demo, we&#8217;ll use &#8216;pymc&#8217;, a package for doing markov chain monte
carlo analysis.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">pylab</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pysd</span>
<span class="kn">import</span> <span class="nn">pymc</span> <span class="k">as</span> <span class="nn">mc</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Populating</span> <span class="n">the</span> <span class="n">interactive</span> <span class="n">namespace</span> <span class="kn">from</span> <span class="nn">numpy</span> <span class="ow">and</span> <span class="n">matplotlib</span>
</pre></div>
</div>
<div class="section" id="load-model">
<h2>Load Model<a class="headerlink" href="#load-model" title="Permalink to this headline">¶</a></h2>
<p>To get a sense for how the model behaves, we&#8217;ll run it with arbitrary
parameter values. We see that pennies enter the &#8216;post production&#8217; stock
quickly, and the &#8216;in circulation&#8217; stock grows, peaks, and decays as the
pennies get lost.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">pysd</span><span class="o">.</span><span class="n">read_vensim</span><span class="p">(</span><span class="s1">&#39;penny_jar.mdl&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="c1">#model.get_free_parameters()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">_subplots</span><span class="o">.</span><span class="n">AxesSubplot</span> <span class="n">at</span> <span class="mh">0x11733d710</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span> <span class="n">at</span> <span class="mh">0x1172e6e10</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../../_images/Penny_Jar_3_2.png" src="../../_images/Penny_Jar_3_2.png" />
</div>
<div class="section" id="load-data">
<h2>Load Data<a class="headerlink" href="#load-data" title="Permalink to this headline">¶</a></h2>
<p>We&#8217;ll start with some data about the number of coins produced in each
year. We have production data for both the Denver and Philadelphia
mints:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">production</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Production_Figures.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
<span class="n">production</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Pennies Produced Per Year&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../../_images/Penny_Jar_5_0.png" src="../../_images/Penny_Jar_5_0.png" />
<p>We&#8217;ll also use &#8216;data&#8217; (pennies) collected in a penny jar over the last
few years</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">coin_counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;pennies_in_jar.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
<span class="n">coin_counts</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Pennies in my Jar&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../../_images/Penny_Jar_7_0.png" src="../../_images/Penny_Jar_7_0.png" />
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">coin_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">All_Marks</span>       <span class="mi">1004</span>
<span class="n">Denver</span>           <span class="mi">209</span>
<span class="n">Philadelphia</span>     <span class="mi">795</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">coin_counts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">coin_counts</span><span class="p">[</span><span class="s1">&#39;Philadelphia&#39;</span><span class="p">]</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">coin_counts</span><span class="p">[</span><span class="s1">&#39;Philadelphia&#39;</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Predicted Pennies in Jar&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Mint Year&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Likelihood for any given penny&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">1950</span><span class="p">,</span><span class="mi">2015</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1950</span><span class="p">,</span> <span class="mi">2015</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/Penny_Jar_9_1.png" src="../../_images/Penny_Jar_9_1.png" />
</div>
<div class="section" id="set-up-models">
<h2>Set up models<a class="headerlink" href="#set-up-models" title="Permalink to this headline">¶</a></h2>
<p>We set up a model for each year that pennies are produced, and
initialize them with production data.</p>
<p>We divide the data to put pennies in units of 100,000 to make life
easier for the integrator. This won&#8217;t matter in the end, as we normalize
the distribution of pennies in circulation before we take our samples.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1">#load a model for each mint year</span>
<span class="n">models</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[[</span><span class="n">year</span><span class="p">,</span> <span class="n">pysd</span><span class="o">.</span><span class="n">read_vensim</span><span class="p">(</span><span class="s1">&#39;penny_jar.mdl&#39;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1930</span><span class="p">,</span><span class="mi">2014</span><span class="p">)],</span>
                      <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">])</span>

<span class="n">models</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#bring in the data on production</span>
<span class="n">models</span><span class="p">[</span><span class="s1">&#39;Philadelphia Production&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">production</span><span class="p">[</span><span class="s1">&#39;Philadelphia&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100000</span>
<span class="c1">#production will now be in units of hundred-thousands</span>

<span class="c1">#bring in the sample data</span>
<span class="n">models</span><span class="p">[</span><span class="s1">&#39;Philadelphia Samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coin_counts</span><span class="p">[</span><span class="s1">&#39;Philadelphia&#39;</span><span class="p">]</span>

<span class="c1">#set the mint year parameters properly</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_components</span><span class="p">({</span><span class="s1">&#39;production_year&#39;</span><span class="p">:</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="s1">&#39;production_volume&#39;</span><span class="p">:</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Philadelphia Production&#39;</span><span class="p">]})</span>

<span class="c1">#drop rows (probably at the end) which are missing data</span>
<span class="n">models</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">models</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="ne">TypeError</span>                                 <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">IPython</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">formatters</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
    <span class="mi">688</span>                 <span class="n">type_pprinters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type_printers</span><span class="p">,</span>
    <span class="mi">689</span>                 <span class="n">deferred_pprinters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deferred_printers</span><span class="p">)</span>
<span class="o">--&gt;</span> <span class="mi">690</span>             <span class="n">printer</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="mi">691</span>             <span class="n">printer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="mi">692</span>             <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">IPython</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pretty</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">pretty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
    <span class="mi">407</span>                             <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">meth</span><span class="p">):</span>
    <span class="mi">408</span>                                 <span class="k">return</span> <span class="n">meth</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
<span class="o">--&gt;</span> <span class="mi">409</span>             <span class="k">return</span> <span class="n">_default_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
    <span class="mi">410</span>         <span class="k">finally</span><span class="p">:</span>
    <span class="mi">411</span>             <span class="bp">self</span><span class="o">.</span><span class="n">end_group</span><span class="p">()</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">IPython</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pretty</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">_default_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
    <span class="mi">527</span>     <span class="k">if</span> <span class="n">_safe_getattr</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="s1">&#39;__repr__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_baseclass_reprs</span><span class="p">:</span>
    <span class="mi">528</span>         <span class="c1"># A user-provided repr. Find newlines and replace them with p.break_()</span>
<span class="o">--&gt;</span> <span class="mi">529</span>         <span class="n">_repr_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
    <span class="mi">530</span>         <span class="k">return</span>
    <span class="mi">531</span>     <span class="n">p</span><span class="o">.</span><span class="n">begin_group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">)</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">IPython</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pretty</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">_repr_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
    <span class="mi">709</span>     <span class="s2">&quot;&quot;&quot;A pprint that just redirects to the normal repr function.&quot;&quot;&quot;</span>
    <span class="mi">710</span>     <span class="c1"># Find newlines and replace them with p.break_()</span>
<span class="o">--&gt;</span> <span class="mi">711</span>     <span class="n">output</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="mi">712</span>     <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">output_line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()):</span>
    <span class="mi">713</span>         <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">base</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
     <span class="mi">62</span>         <span class="n">Yields</span> <span class="n">Bytestring</span> <span class="ow">in</span> <span class="n">Py2</span><span class="p">,</span> <span class="n">Unicode</span> <span class="n">String</span> <span class="ow">in</span> <span class="n">py3</span><span class="o">.</span>
     <span class="mi">63</span>         <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">---&gt; 64         return str(self)</span>
<span class="s2">     65</span>
<span class="s2">     66</span>


<span class="s2">/Library/Python/2.7/site-packages/pandas/core/base.pyc in __str__(self)</span>
<span class="s2">     42         if compat.PY3:</span>
<span class="s2">     43             return self.__unicode__()</span>
<span class="s2">---&gt; 44         return self.__bytes__()</span>
<span class="s2">     45</span>
<span class="s2">     46     def __bytes__(self):</span>


<span class="s2">/Library/Python/2.7/site-packages/pandas/core/base.pyc in __bytes__(self)</span>
<span class="s2">     54</span>
<span class="s2">     55         encoding = get_option(&quot;display.encoding&quot;)</span>
<span class="s2">---&gt; 56         return self.__unicode__().encode(encoding, &#39;replace&#39;)</span>
<span class="s2">     57</span>
<span class="s2">     58     def __repr__(self):</span>


<span class="s2">/Library/Python/2.7/site-packages/pandas/core/frame.pyc in __unicode__(self)</span>
<span class="s2">    507             width = None</span>
<span class="s2">    508         self.to_string(buf=buf, max_rows=max_rows, max_cols=max_cols,</span>
<span class="s2">--&gt; 509                        line_width=width, show_dimensions=show_dimensions)</span>
<span class="s2">    510</span>
<span class="s2">    511         return buf.getvalue()</span>


<span class="s2">/Library/Python/2.7/site-packages/pandas/core/frame.pyc in to_string(self, buf, columns, col_space, colSpace, header, index, na_rep, formatters, float_format, sparsify, index_names, justify, line_width, max_rows, max_cols, show_dimensions)</span>
<span class="s2">   1341                                            max_cols=max_cols,</span>
<span class="s2">   1342                                            show_dimensions=show_dimensions)</span>
<span class="s2">-&gt; 1343         formatter.to_string()</span>
<span class="s2">   1344</span>
<span class="s2">   1345         if buf is None:</span>


<span class="s2">/Library/Python/2.7/site-packages/pandas/core/format.pyc in to_string(self)</span>
<span class="s2">    509             text = info_line</span>
<span class="s2">    510         else:</span>
<span class="s2">--&gt; 511             strcols = self._to_str_columns()</span>
<span class="s2">    512             if self.line_width is None:  # no need to wrap around just print the whole frame</span>
<span class="s2">    513                 text = adjoin(1, *strcols)</span>


<span class="s2">/Library/Python/2.7/site-packages/pandas/core/format.pyc in _to_str_columns(self)</span>
<span class="s2">    437                                    *(_strlen(x) for x in cheader))</span>
<span class="s2">    438</span>
<span class="s2">--&gt; 439                 fmt_values = self._format_col(i)</span>
<span class="s2">    440</span>
<span class="s2">    441                 fmt_values = _make_fixed_width(fmt_values, self.justify,</span>


<span class="s2">/Library/Python/2.7/site-packages/pandas/core/format.pyc in _format_col(self, i)</span>
<span class="s2">    691             (frame.iloc[:, i]).get_values(),</span>
<span class="s2">    692             formatter, float_format=self.float_format, na_rep=self.na_rep,</span>
<span class="s2">--&gt; 693             space=self.col_space</span>
<span class="s2">    694         )</span>
<span class="s2">    695</span>


<span class="s2">/Library/Python/2.7/site-packages/pandas/core/format.pyc in format_array(values, formatter, float_format, na_rep, digits, space, justify)</span>
<span class="s2">   1928                         justify=justify)</span>
<span class="s2">   1929</span>
<span class="s2">-&gt; 1930     return fmt_obj.get_result()</span>
<span class="s2">   1931</span>
<span class="s2">   1932</span>


<span class="s2">/Library/Python/2.7/site-packages/pandas/core/format.pyc in get_result(self)</span>
<span class="s2">   1944</span>
<span class="s2">   1945     def get_result(self):</span>
<span class="s2">-&gt; 1946         fmt_values = self._format_strings()</span>
<span class="s2">   1947         return _make_fixed_width(fmt_values, self.justify)</span>
<span class="s2">   1948</span>


<span class="s2">/Library/Python/2.7/site-packages/pandas/core/format.pyc in _format_strings(self)</span>
<span class="s2">   1982                 fmt_values.append(float_format(v))</span>
<span class="s2">   1983             else:</span>
<span class="s2">-&gt; 1984                 fmt_values.append(&#39; </span><span class="si">%s</span><span class="s2">&#39; % _format(v))</span>
<span class="s2">   1985</span>
<span class="s2">   1986         return fmt_values</span>


<span class="s2">/Library/Python/2.7/site-packages/pandas/core/format.pyc in _format(x)</span>
<span class="s2">   1968             else:</span>
<span class="s2">   1969                 # object dtype</span>
<span class="s2">-&gt; 1970                 return &#39;</span><span class="si">%s</span><span class="s2">&#39; </span><span class="si">% f</span><span class="s2">ormatter(x)</span>
<span class="s2">   1971</span>
<span class="s2">   1972         vals = self.values</span>


<span class="s2">/Library/Python/2.7/site-packages/pandas/core/format.pyc in &lt;lambda&gt;(x)</span>
<span class="s2">   1957</span>
<span class="s2">   1958         formatter = self.formatter if self.formatter is not None else </span><span class="se">\</span>
<span class="s2">-&gt; 1959             (lambda x: com.pprint_thing(x, escape_chars=(&#39;</span><span class="se">\t</span><span class="s2">&#39;, &#39;</span><span class="se">\r</span><span class="s2">&#39;, &#39;</span><span class="se">\n</span><span class="s2">&#39;)))</span>
<span class="s2">   1960</span>
<span class="s2">   1961         def _format(x):</span>


<span class="s2">/Library/Python/2.7/site-packages/pandas/core/common.pyc in pprint_thing(thing, _nest_lvl, escape_chars, default_escapes, quote_strings, max_seq_items)</span>
<span class="s2">   3275         result = fmt % as_escaped_unicode(thing)</span>
<span class="s2">   3276     else:</span>
<span class="s2">-&gt; 3277         result = as_escaped_unicode(thing)</span>
<span class="s2">   3278</span>
<span class="s2">   3279     return compat.text_type(result)  # always unicode</span>


<span class="s2">/Library/Python/2.7/site-packages/pandas/core/common.pyc in as_escaped_unicode(thing, escape_chars)</span>
<span class="s2">   3237</span>
<span class="s2">   3238         try:</span>
<span class="s2">-&gt; 3239             result = compat.text_type(thing)  # we should try this first</span>
<span class="s2">   3240         except UnicodeDecodeError:</span>
<span class="s2">   3241             # either utf-8 or we replace errors</span>


<span class="s2">TypeError: coercing to Unicode: need string or buffer, method-wrapper found</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="ne">TypeError</span>                                 <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">IPython</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">formatters</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
    <span class="mi">332</span>             <span class="n">method</span> <span class="o">=</span> <span class="n">_safe_get_formatter_method</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_method</span><span class="p">)</span>
    <span class="mi">333</span>             <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="o">--&gt;</span> <span class="mi">334</span>                 <span class="k">return</span> <span class="n">method</span><span class="p">()</span>
    <span class="mi">335</span>             <span class="k">return</span> <span class="kc">None</span>
    <span class="mi">336</span>         <span class="k">else</span><span class="p">:</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">frame</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">541</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">max_rows</span><span class="o">=</span><span class="n">max_rows</span><span class="p">,</span> <span class="n">max_cols</span><span class="o">=</span><span class="n">max_cols</span><span class="p">,</span>
    <span class="mi">542</span>                                 <span class="n">show_dimensions</span><span class="o">=</span><span class="n">show_dimensions</span><span class="p">,</span>
<span class="o">--&gt;</span> <span class="mi">543</span>                                 <span class="n">notebook</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="mi">544</span>         <span class="k">else</span><span class="p">:</span>
    <span class="mi">545</span>             <span class="k">return</span> <span class="kc">None</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">frame</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">to_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">col_space</span><span class="p">,</span> <span class="n">colSpace</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">na_rep</span><span class="p">,</span> <span class="n">formatters</span><span class="p">,</span> <span class="n">float_format</span><span class="p">,</span> <span class="n">sparsify</span><span class="p">,</span> <span class="n">index_names</span><span class="p">,</span> <span class="n">justify</span><span class="p">,</span> <span class="n">bold_rows</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">escape</span><span class="p">,</span> <span class="n">max_rows</span><span class="p">,</span> <span class="n">max_cols</span><span class="p">,</span> <span class="n">show_dimensions</span><span class="p">,</span> <span class="n">notebook</span><span class="p">)</span>
   <span class="mi">1392</span>                                            <span class="n">max_cols</span><span class="o">=</span><span class="n">max_cols</span><span class="p">,</span>
   <span class="mi">1393</span>                                            <span class="n">show_dimensions</span><span class="o">=</span><span class="n">show_dimensions</span><span class="p">)</span>
<span class="o">-&gt;</span> <span class="mi">1394</span>         <span class="n">formatter</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span> <span class="n">notebook</span><span class="o">=</span><span class="n">notebook</span><span class="p">)</span>
   <span class="mi">1395</span>
   <span class="mi">1396</span>         <span class="k">if</span> <span class="n">buf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="nb">format</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">to_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">notebook</span><span class="p">)</span>
    <span class="mi">709</span>                                       <span class="n">notebook</span><span class="o">=</span><span class="n">notebook</span><span class="p">)</span>
    <span class="mi">710</span>         <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">):</span>
<span class="o">--&gt;</span> <span class="mi">711</span>             <span class="n">html_renderer</span><span class="o">.</span><span class="n">write_result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">)</span>
    <span class="mi">712</span>         <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
    <span class="mi">713</span>             <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="nb">format</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">write_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
    <span class="mi">917</span>         <span class="n">indent</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent_delta</span>
    <span class="mi">918</span>         <span class="n">indent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_header</span><span class="p">(</span><span class="n">indent</span><span class="p">)</span>
<span class="o">--&gt;</span> <span class="mi">919</span>         <span class="n">indent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_body</span><span class="p">(</span><span class="n">indent</span><span class="p">)</span>
    <span class="mi">920</span>
    <span class="mi">921</span>         <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/table&gt;&#39;</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="nb">format</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">_write_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>
   <span class="mi">1065</span>         <span class="n">fmt_values</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="mi">1066</span>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cols</span><span class="p">)):</span>
<span class="o">-&gt;</span> <span class="mi">1067</span>             <span class="n">fmt_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="o">.</span><span class="n">_format_col</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
   <span class="mi">1068</span>
   <span class="mi">1069</span>         <span class="c1"># write values</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="nb">format</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">_format_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="mi">691</span>             <span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">get_values</span><span class="p">(),</span>
    <span class="mi">692</span>             <span class="n">formatter</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">float_format</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">na_rep</span><span class="p">,</span>
<span class="o">--&gt;</span> <span class="mi">693</span>             <span class="n">space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col_space</span>
    <span class="mi">694</span>         <span class="p">)</span>
    <span class="mi">695</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="nb">format</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">format_array</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">formatter</span><span class="p">,</span> <span class="n">float_format</span><span class="p">,</span> <span class="n">na_rep</span><span class="p">,</span> <span class="n">digits</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">justify</span><span class="p">)</span>
   <span class="mi">1928</span>                         <span class="n">justify</span><span class="o">=</span><span class="n">justify</span><span class="p">)</span>
   <span class="mi">1929</span>
<span class="o">-&gt;</span> <span class="mi">1930</span>     <span class="k">return</span> <span class="n">fmt_obj</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
   <span class="mi">1931</span>
   <span class="mi">1932</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="nb">format</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">get_result</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
   <span class="mi">1944</span>
   <span class="mi">1945</span>     <span class="k">def</span> <span class="nf">get_result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="o">-&gt;</span> <span class="mi">1946</span>         <span class="n">fmt_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_strings</span><span class="p">()</span>
   <span class="mi">1947</span>         <span class="k">return</span> <span class="n">_make_fixed_width</span><span class="p">(</span><span class="n">fmt_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">justify</span><span class="p">)</span>
   <span class="mi">1948</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="nb">format</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">_format_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
   <span class="mi">1982</span>                 <span class="n">fmt_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">float_format</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
   <span class="mi">1983</span>             <span class="k">else</span><span class="p">:</span>
<span class="o">-&gt;</span> <span class="mi">1984</span>                 <span class="n">fmt_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_format</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
   <span class="mi">1985</span>
   <span class="mi">1986</span>         <span class="k">return</span> <span class="n">fmt_values</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="nb">format</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">_format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
   <span class="mi">1968</span>             <span class="k">else</span><span class="p">:</span>
   <span class="mi">1969</span>                 <span class="c1"># object dtype</span>
<span class="o">-&gt;</span> <span class="mi">1970</span>                 <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">formatter</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
   <span class="mi">1971</span>
   <span class="mi">1972</span>         <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="nb">format</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="k">lambda</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
   <span class="mi">1957</span>
   <span class="mi">1958</span>         <span class="n">formatter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> \
<span class="o">-&gt;</span> <span class="mi">1959</span>             <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">com</span><span class="o">.</span><span class="n">pprint_thing</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">escape_chars</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)))</span>
   <span class="mi">1960</span>
   <span class="mi">1961</span>         <span class="k">def</span> <span class="nf">_format</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">common</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">pprint_thing</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">_nest_lvl</span><span class="p">,</span> <span class="n">escape_chars</span><span class="p">,</span> <span class="n">default_escapes</span><span class="p">,</span> <span class="n">quote_strings</span><span class="p">,</span> <span class="n">max_seq_items</span><span class="p">)</span>
   <span class="mi">3275</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="n">as_escaped_unicode</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
   <span class="mi">3276</span>     <span class="k">else</span><span class="p">:</span>
<span class="o">-&gt;</span> <span class="mi">3277</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">as_escaped_unicode</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
   <span class="mi">3278</span>
   <span class="mi">3279</span>     <span class="k">return</span> <span class="n">compat</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>  <span class="c1"># always unicode</span>


<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">common</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">as_escaped_unicode</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">escape_chars</span><span class="p">)</span>
   <span class="mi">3237</span>
   <span class="mi">3238</span>         <span class="k">try</span><span class="p">:</span>
<span class="o">-&gt;</span> <span class="mi">3239</span>             <span class="n">result</span> <span class="o">=</span> <span class="n">compat</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>  <span class="c1"># we should try this first</span>
   <span class="mi">3240</span>         <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
   <span class="mi">3241</span>             <span class="c1"># either utf-8 or we replace errors</span>


<span class="ne">TypeError</span><span class="p">:</span> <span class="n">coercing</span> <span class="n">to</span> <span class="n">Unicode</span><span class="p">:</span> <span class="n">need</span> <span class="n">string</span> <span class="ow">or</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">method</span><span class="o">-</span><span class="n">wrapper</span> <span class="n">found</span>
</pre></div>
</div>
</div>
<div class="section" id="set-up-a-markov-chain-monte-carlo-analysis">
<h2>Set up a Markov Chain Monte Carlo Analysis<a class="headerlink" href="#set-up-a-markov-chain-monte-carlo-analysis" title="Permalink to this headline">¶</a></h2>
<p>MCMC works by choosing an arbitrary value from a distribution of input
parameters, running the simulation, and asking what the likelihood of
the data is given those parameters. It then decides whether to keep the
selected parameters to display in an output distribution based upon this
likeliood.</p>
<p>We start then by setting up a &#8216;prior&#8217; distribution for the loss rate and
entry rate parameters that will be applied to each of the mint year
models.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">entry_rate</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s1">&#39;entry_rate&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=.</span><span class="mi">99</span><span class="p">,</span> <span class="n">value</span><span class="o">=.</span><span class="mi">08</span><span class="p">)</span>
<span class="n">loss_rate</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s1">&#39;loss_rate&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span> <span class="n">value</span><span class="o">=.</span><span class="mi">025</span><span class="p">)</span>
</pre></div>
</div>
<p>We&#8217;ll ask our models for the population of coins from which the sample
was drawn, and as this happened over a period of time, not all in the
same timestep, we&#8217;ll assume that there is equal likelihood that a sample
was drawn (or a penny collected) any time during that window.</p>
<p>We then construct a function that returns to us the likelihood of the
data given the distribution of pennies in circulation, as calculated by
our model.</p>
<p>PyMC expects this likelihood to be expressed as a log probability, to
give resolution in the &#8216;very small likelihood&#8217; regimes that our model
will predict for our observations.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_population</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">entry_rate</span><span class="p">,</span> <span class="n">loss_rate</span><span class="p">):</span>
    <span class="n">in_circulation</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;entry_rate&#39;</span><span class="p">:</span><span class="n">entry_rate</span><span class="p">,</span> <span class="s1">&#39;loss_rate&#39;</span><span class="p">:</span><span class="n">loss_rate</span><span class="p">},</span>
                               <span class="n">return_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_circulation&#39;</span><span class="p">],</span>
                               <span class="n">return_timestamps</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span><span class="mi">2015</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">in_circulation</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nd">@mc</span><span class="o">.</span><span class="n">stochastic</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#stupid observed flag! got to get that right!</span>
<span class="k">def</span> <span class="nf">circulation</span><span class="p">(</span><span class="n">entry_rate</span><span class="o">=</span><span class="n">entry_rate</span><span class="p">,</span> <span class="n">loss_rate</span><span class="o">=</span><span class="n">loss_rate</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">mapfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_population</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="n">entry_rate</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="n">loss_rate</span><span class="p">)</span>
    <span class="n">population</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">mapfunc</span><span class="p">)</span>

    <span class="c1">#transform to log probability and then normalize (in the log domain, just by subtraction)</span>
    <span class="n">log_distribution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">population</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">population</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="c1">#calculate the probability of the data from the distribution</span>
    <span class="n">log_prob</span> <span class="o">=</span> <span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;Philadelphia Samples&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">log_distribution</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">log_prob</span>
</pre></div>
</div>
</div>
<div class="section" id="perform-the-mcmc-sampling">
<h2>Perform the MCMC Sampling<a class="headerlink" href="#perform-the-mcmc-sampling" title="Permalink to this headline">¶</a></h2>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mcmc</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">MCMC</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">Model</span><span class="p">([</span><span class="n">entry_rate</span><span class="p">,</span> <span class="n">loss_rate</span><span class="p">,</span> <span class="n">circulation</span><span class="p">]))</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1">#mcmc.sample(20000)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">------------------</span><span class="mi">110</span><span class="o">%-------------------</span><span class="p">]</span> <span class="mi">11</span> <span class="n">of</span> <span class="mi">10</span> <span class="n">complete</span> <span class="ow">in</span> <span class="mf">435.2</span> <span class="n">sec</span>
</pre></div>
</div>
</div>
<div class="section" id="plot-the-results">
<h2>Plot the results<a class="headerlink" href="#plot-the-results" title="Permalink to this headline">¶</a></h2>
<p>We can plot a histogram of the output of the MCMC analysis, showing the
uncertainty in our estimate of the loss rate and entry rate based upon
our model and data selection. We also see that these distributions are
not entirely independant, by plotting the sample values for each
parameter against one another, and using a hex-binned two-dimensional
histogram.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">mcmc</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;loss_rate&#39;</span><span class="p">)[</span><span class="mi">10000</span><span class="p">:],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Loss Rate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Loss Rate Likelihood&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">mcmc</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;entry_rate&#39;</span><span class="p">)[</span><span class="mi">10000</span><span class="p">:],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Entry Rate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Entry Rate Likelihood&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">hexbin</span><span class="p">(</span><span class="n">mcmc</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;loss_rate&#39;</span><span class="p">)[:],</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;entry_rate&#39;</span><span class="p">)[:],</span> <span class="n">gridsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Loss Rate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Entry Rate&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>


          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, James Houghton.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>