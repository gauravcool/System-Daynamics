

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using SD models to understand the differences between population measures at varying levels of geographic disagregation &mdash; PySD-Cookbook 0.1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="PySD-Cookbook 0.1.0 documentation" href="../../index.html"/>
        <link rel="up" title="Geographic Analyses" href="index_geo.html"/>
        <link rel="next" title="Surrogating Functions" href="../surrogating_functions/index_surrogate.html"/>
        <link rel="prev" title="Installation" href="Doing_more_with_spatialdata_multi_regional_SIR_Model.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> PySD-Cookbook</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index_getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Introduction.html">Introduction to the PySD Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Installing.html">Installation and Setup of Python and PySD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Python.html">Getting Started with Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Notebook.html">Using the Jupyter Notebook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Git_and_Github.html">Working with <code class="docutils literal"><span class="pre">git</span></code> and github</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Hello_World_Teacup.html">Hello World: The Teacup Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../data_handling/index_data_handling.html">Data Handling</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../data_handling/pandas.html">Data handling with Pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_handling/Writing_to_Database.html">Saving Simulation Results to a Database</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/index_visualization.html">Visualization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../visualization/matplotlib.html">Basic Visualization with <code class="docutils literal"><span class="pre">matplotlib</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../visualization/other_visualization_libraries.html">Other Visualization Packages in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../visualization/phase_portraits.html">Phase Portraits</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../fitting/index_fitting.html">Model Fitting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../fitting/Fitting_with_Optimization.html">Fitting a model&#8217;s parameters with run-at-a-time optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fitting/Step_at_a_time_optimization.html">Step-at-a-time optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fitting/Massively_Parallel_Fitting.html">Parallel Model Fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fitting/MCMC_for_fitting_models.html">Fitting a model with Markov Chain Monte Carlo</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index_geo.html">Geographic Analyses</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Doing_more_with_spatialdata_multi_regional_SIR_Model.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="Doing_more_with_spatialdata_multi_regional_SIR_Model.html#using-sd-to-understand-the-sd-fever">Using SD to understand the SD Fever</a></li>
<li class="toctree-l2"><a class="reference internal" href="Doing_more_with_spatialdata_multi_regional_SIR_Model.html#modify-parameter-values">Modify parameter values</a></li>
<li class="toctree-l2"><a class="reference internal" href="Doing_more_with_spatialdata_multi_regional_SIR_Model.html#change-model-settings">Change Model settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="Doing_more_with_spatialdata_multi_regional_SIR_Model.html#geographical-information">Geographical Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="Doing_more_with_spatialdata_multi_regional_SIR_Model.html#run-the-model-for-each-country">Run the model for each country</a></li>
<li class="toctree-l2"><a class="reference internal" href="Doing_more_with_spatialdata_multi_regional_SIR_Model.html#transpose-simulation-results-for-plotting">Transpose simulation results for plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="Doing_more_with_spatialdata_multi_regional_SIR_Model.html#comparative-analysis">Comparative Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="Doing_more_with_spatialdata_multi_regional_SIR_Model.html#analysis-of-results">Analysis of results</a></li>
<li class="toctree-l2"><a class="reference internal" href="Doing_more_with_spatialdata_multi_regional_SIR_Model.html#how-spatial-analysis-leads-to-insight">How Spatial Analysis Leads to Insight</a></li>
<li class="toctree-l2"><a class="reference internal" href="Doing_more_with_spatialdata_multi_regional_SIR_Model.html#plotting-simulation-results-on-map-with-ipywidgets">Plotting simulation results on map with Ipywidgets</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Using SD models to understand the differences between population measures at varying levels of geographic disagregation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../surrogating_functions/index_surrogate.html">Surrogating Functions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../surrogating_functions/Surrogating_with_regression.html">Surrogating a function with a machine learning estimator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../surrogating_functions/Surrogating_with_regression_Workbook.html">Surrogating a function with a machine learning estimator</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../realtime/index_realtime.html">Realtime Data Incorporation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../realtime/Nth_Order_Delay_Demo.html">Nth Order Delay Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../realtime/Twitter_Stream.html">Feeding models with realtime streaming data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../workflow/index_workflow.html">Model Development Workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../workflow/Unit_Testing.html">Unit Testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../data/index_data.html">Data Used in this Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../data/Baby_Names/Baby_Name_Data.html">Baby Name Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data/Census/US_Census_Data_Collection.html">Collecting US decennial census data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data/Climate/sources.html">Carbon Data Sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data/Defects_Synthetic/Manufacturing_Defects_Synthetic.html">Manufacturing Defects Synthetic Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data/Ebola/Ebola_Data_Loader.html">Ebola Data Loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data/Emails/Email_Data_Formatter.html">Parse gmail <code class="docutils literal"><span class="pre">.mbox</span></code> file</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../future.html">Chapters to be Written</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../endnotes.html">End Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../endnotes.html#for-instruction">For instruction</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">PySD-Cookbook</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index_geo.html">Geographic Analyses</a> &raquo;</li>
      
    <li>Using SD models to understand the differences between population measures at varying levels of geographic disagregation</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../../_sources/analyses/geo/Exploring_models_across_geographic_scales.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="using-sd-models-to-understand-the-differences-between-population-measures-at-varying-levels-of-geographic-disagregation">
<h1>Using SD models to understand the differences between population measures at varying levels of geographic disagregation<a class="headerlink" href="#using-sd-models-to-understand-the-differences-between-population-measures-at-varying-levels-of-geographic-disagregation" title="Permalink to this headline">¶</a></h1>
<p>In this recipe, we will use data at a national level to infer parameters
for a population aging model. We&#8217;ll then try two different ways of using
this trained model to understand variation between the behavior of each
of the states.</p>
<div class="section" id="about-this-technique">
<h2>About this technique<a class="headerlink" href="#about-this-technique" title="Permalink to this headline">¶</a></h2>
<p>Firstly, we&#8217;ll use the parameters fit at the national level to predict
census data at the disaggregated level, and compare these predicted
state-level outputs with the measured values. This gives us a sense for
how different the populations of the states are from what we should
expect given our understanding of the national picture.</p>
<p>Secondly, we&#8217;ll fit parameters to a model at each of the state levels
actual measured census data, and then compare the differences in fit
parameters to each other and to the national expectation. This is a
helpful analysis if the parameter itself (and its inter-state variance)
is what we find interesting.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">pylab</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pysd</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Populating</span> <span class="n">the</span> <span class="n">interactive</span> <span class="n">namespace</span> <span class="kn">from</span> <span class="nn">numpy</span> <span class="ow">and</span> <span class="n">matplotlib</span>
</pre></div>
</div>
</div>
<div class="section" id="ingredients">
<h2>Ingredients<a class="headerlink" href="#ingredients" title="Permalink to this headline">¶</a></h2>
<div class="section" id="population-data-by-age-cohort">
<h3>Population data by age cohort<a class="headerlink" href="#population-data-by-age-cohort" title="Permalink to this headline">¶</a></h3>
<p>We start with data from the decennial census years 2000 and 2010, for
the male population by state and county. We have aggregated the data
into ten-year age cohorts (with the last cohort representing everyone
over 80 years old). The data collection task is described
<a class="reference external" href="data/Census/US%20Census%20Data%20Collection.ipynb">here</a>. In this
analysis we will only use data at the state and national levels.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../../data/Census/Males by decade and county.csv&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="9" halign="left">2000</th>
      <th colspan="9" halign="left">2010</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>dec_1</th>
      <th>dec_2</th>
      <th>dec_3</th>
      <th>dec_4</th>
      <th>dec_5</th>
      <th>dec_6</th>
      <th>dec_7</th>
      <th>dec_8</th>
      <th>dec_9</th>
      <th>dec_1</th>
      <th>dec_2</th>
      <th>dec_3</th>
      <th>dec_4</th>
      <th>dec_5</th>
      <th>dec_6</th>
      <th>dec_7</th>
      <th>dec_8</th>
      <th>dec_9</th>
    </tr>
    <tr>
      <th>state</th>
      <th>county</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1</th>
      <th>1</th>
      <td>3375</td>
      <td>3630</td>
      <td>2461</td>
      <td>3407</td>
      <td>3283</td>
      <td>2319</td>
      <td>1637</td>
      <td>825</td>
      <td>284</td>
      <td>3867</td>
      <td>4384</td>
      <td>3082</td>
      <td>3598</td>
      <td>4148</td>
      <td>3390</td>
      <td>2293</td>
      <td>1353</td>
      <td>454</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9323</td>
      <td>10094</td>
      <td>7600</td>
      <td>9725</td>
      <td>10379</td>
      <td>8519</td>
      <td>6675</td>
      <td>4711</td>
      <td>1822</td>
      <td>11446</td>
      <td>12006</td>
      <td>9976</td>
      <td>11042</td>
      <td>12517</td>
      <td>12368</td>
      <td>10623</td>
      <td>6307</td>
      <td>2911</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2002</td>
      <td>2198</td>
      <td>2412</td>
      <td>2465</td>
      <td>2178</td>
      <td>1699</td>
      <td>1026</td>
      <td>689</td>
      <td>301</td>
      <td>1673</td>
      <td>1739</td>
      <td>2260</td>
      <td>2208</td>
      <td>2233</td>
      <td>1910</td>
      <td>1490</td>
      <td>739</td>
      <td>324</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1546</td>
      <td>1460</td>
      <td>1680</td>
      <td>1762</td>
      <td>1624</td>
      <td>1237</td>
      <td>774</td>
      <td>475</td>
      <td>187</td>
      <td>1471</td>
      <td>1577</td>
      <td>1798</td>
      <td>2016</td>
      <td>1928</td>
      <td>1581</td>
      <td>1140</td>
      <td>579</td>
      <td>211</td>
    </tr>
    <tr>
      <th>9</th>
      <td>3741</td>
      <td>3615</td>
      <td>3393</td>
      <td>3901</td>
      <td>3773</td>
      <td>3007</td>
      <td>2227</td>
      <td>1269</td>
      <td>550</td>
      <td>3741</td>
      <td>4252</td>
      <td>3312</td>
      <td>3719</td>
      <td>4129</td>
      <td>3782</td>
      <td>3052</td>
      <td>1723</td>
      <td>652</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="a-model-of-an-aging-population">
<h3>A model of an aging population<a class="headerlink" href="#a-model-of-an-aging-population" title="Permalink to this headline">¶</a></h3>
<p>The model we&#8217;ll use to represent the population is a simple aging chain,
with individuals aggregated into stocks by decade, to match the
agregation we used for the above data. Each cohort is promoted with a
timescale of 10 years, and there is some net inmigration, outmigration,
and death subsumed into the <code class="docutils literal"><span class="pre">loss</span></code> flow associated with each cohort.
This loss is controled by some yearly fraction that it will be our task
to understand.</p>
<a class="reference internal image-reference" href="../../_images/Aging_Chain.png"><img alt="../../_images/Aging_Chain.png" src="../../_images/Aging_Chain.png" style="width: 600px;" /></a>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">pysd</span><span class="o">.</span><span class="n">read_vensim</span><span class="p">(</span><span class="s1">&#39;../../models/Aging_Chain/Aging_Chain.mdl&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Our model is initialy parameterized with 10 individuals in each stock,
no births, and a uniform loss rate of 5%. We&#8217;ll use data to set the
initial conditions, and infer the loss rates. Estimating births is
difficult, and so for this analysis, we&#8217;ll pay attention only to
individuals who have been born before the year 2000.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<img alt="../../_images/Exploring_models_across_geographic_scales_8_0.png" src="../../_images/Exploring_models_across_geographic_scales_8_0.png" />
</div>
<div class="section" id="geography-information">
<h3>Geography Information<a class="headerlink" href="#geography-information" title="Permalink to this headline">¶</a></h3>
<p>This information comes to us as a shape file <code class="docutils literal"><span class="pre">.shp</span></code> with its
associated <code class="docutils literal"><span class="pre">.dbf</span></code> and <code class="docutils literal"><span class="pre">.shx</span></code> conspirator files. Lets check the
plotting functionality:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">state_geo</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;../../data/Census/US_State.shp&#39;</span><span class="p">)</span>
<span class="n">state_geo</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;StateFIPSN&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">state_geo</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
<span class="n">state_geo</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CensusDiv</th>
      <th>CensusReg</th>
      <th>FIPS</th>
      <th>FIPSNum</th>
      <th>Notes</th>
      <th>OBJECTID</th>
      <th>StateFIPS</th>
      <th>StateName</th>
      <th>XCentroid</th>
      <th>YCentroid</th>
      <th>geometry</th>
    </tr>
    <tr>
      <th>StateFIPSN</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>Pacific</td>
      <td>West</td>
      <td>02000</td>
      <td>2000</td>
      <td>None</td>
      <td>1</td>
      <td>02</td>
      <td>Alaska</td>
      <td>-1882092.15195</td>
      <td>2310348.392810</td>
      <td>(POLYGON ((-2247528.774479387 2237995.01157197...</td>
    </tr>
    <tr>
      <th>53</th>
      <td>Pacific</td>
      <td>West</td>
      <td>53000</td>
      <td>53000</td>
      <td>None</td>
      <td>9</td>
      <td>53</td>
      <td>Washington</td>
      <td>-1837353.15317</td>
      <td>1340481.223852</td>
      <td>(POLYGON ((-2124362.24278068 1480441.850674443...</td>
    </tr>
  </tbody>
</table>
</div><img alt="../../_images/Exploring_models_across_geographic_scales_10_1.png" src="../../_images/Exploring_models_across_geographic_scales_10_1.png" />
</div>
</div>
<div class="section" id="recipe-part-a-predict-state-level-values-from-national-model-fit">
<h2>Recipe Part A: Predict state-level values from national model fit<a class="headerlink" href="#recipe-part-a-predict-state-level-values-from-national-model-fit" title="Permalink to this headline">¶</a></h2>
<div class="section" id="step-1-initialize-the-model-using-census-data">
<h3>Step 1: Initialize the model using census data<a class="headerlink" href="#step-1-initialize-the-model-using-census-data" title="Permalink to this headline">¶</a></h3>
<p>We can aggregate the county level data to the national scale by summing
across all geographies. This is relatively straightforward.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">country</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">country</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">2000</span>  <span class="n">dec_1</span>    <span class="mi">20332536</span>
      <span class="n">dec_2</span>    <span class="mi">20909490</span>
      <span class="n">dec_3</span>    <span class="mi">19485544</span>
      <span class="n">dec_4</span>    <span class="mi">21638975</span>
      <span class="n">dec_5</span>    <span class="mi">21016627</span>
      <span class="n">dec_6</span>    <span class="mi">15115009</span>
      <span class="n">dec_7</span>     <span class="mi">9536197</span>
      <span class="n">dec_8</span>     <span class="mi">6946906</span>
      <span class="n">dec_9</span>     <span class="mi">3060483</span>
<span class="mi">2010</span>  <span class="n">dec_1</span>    <span class="mi">20703935</span>
      <span class="n">dec_2</span>    <span class="mi">21878666</span>
      <span class="n">dec_3</span>    <span class="mi">21645336</span>
      <span class="n">dec_4</span>    <span class="mi">20033352</span>
      <span class="n">dec_5</span>    <span class="mi">21597437</span>
      <span class="n">dec_6</span>    <span class="mi">20451686</span>
      <span class="n">dec_7</span>    <span class="mi">13926846</span>
      <span class="n">dec_8</span>     <span class="mi">7424945</span>
      <span class="n">dec_9</span>     <span class="mi">4083435</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
<p>If we run the model using national data from the year 2000 as starting
conditions, we can see how the cohorts develop, given our arbitrary loss
rate values:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">return_timestamps</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2011</span><span class="p">),</span>
          <span class="n">initial_condition</span><span class="o">=</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">country</span><span class="p">[</span><span class="s1">&#39;2000&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<img alt="../../_images/Exploring_models_across_geographic_scales_14_0.png" src="../../_images/Exploring_models_across_geographic_scales_14_0.png" />
</div>
<div class="section" id="step-2-fit-the-national-level-model-to-the-remaining-data">
<h3>Step 2: Fit the national level model to the remaining data<a class="headerlink" href="#step-2-fit-the-national-level-model-to-the-remaining-data" title="Permalink to this headline">¶</a></h3>
<p>We&#8217;ve used half of our data (from the year 2000 census) to initialize
our model. Now we&#8217;ll use an optimization routine to choose the loss rate
parameters that best predict the census 2010 data. We&#8217;ll use the same
basic operations described in the previous recipe: <a class="reference external" href="2_1_Fitting_with_Optimization.ipynb">Fitting with
Optimization</a>.</p>
<p>To make this simple, we&#8217;ll write a function that takes a list of
potential model parameters, and returns the model&#8217;s prediction in the
year 2010</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">exec_model</span><span class="p">(</span><span class="n">paramlist</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;dec_</span><span class="si">%i</span><span class="s1">_loss_rate&#39;</span><span class="o">%</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)],</span> <span class="n">paramlist</span><span class="p">))</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">initial_condition</span><span class="o">=</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="n">country</span><span class="p">[</span><span class="s1">&#39;2000&#39;</span><span class="p">]),</span>
                       <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">return_timestamps</span><span class="o">=</span><span class="mi">2010</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
<p>Now we&#8217;ll define an error function that calls this executor and
calculates a sum of squared errors value. Remember that because we don&#8217;t
have birth information, we&#8217;ll only calculate error based upon age
cohorts 2 through 9.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">paramlist</span><span class="p">):</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">exec_model</span><span class="p">(</span><span class="n">paramlist</span><span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">output</span> <span class="o">-</span> <span class="n">country</span><span class="p">[</span><span class="s1">&#39;2010&#39;</span><span class="p">]</span>
    <span class="c1">#don&#39;t tally errors in the first cohort, as we don&#39;t have info about births</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can use the minimize function from scipy to find a vector of
parameters which brings the 2010 predictions into alignment with the
data.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">05</span><span class="p">]</span><span class="o">*</span><span class="mi">9</span><span class="p">,</span>
                              <span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">)</span>
<span class="n">country_level_fit_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;dec_</span><span class="si">%i</span><span class="s1">_loss_rate&#39;</span><span class="o">%</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]))</span>
<span class="n">country_level_fit_params</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;dec_1_loss_rate&#39;</span><span class="p">:</span> <span class="mf">0.021183432598200467</span><span class="p">,</span>
 <span class="s1">&#39;dec_2_loss_rate&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.052101419562612286</span><span class="p">,</span>
 <span class="s1">&#39;dec_3_loss_rate&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0014091019293939956</span><span class="p">,</span>
 <span class="s1">&#39;dec_4_loss_rate&#39;</span><span class="p">:</span> <span class="mf">0.0088436979759478375</span><span class="p">,</span>
 <span class="s1">&#39;dec_5_loss_rate&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0072046351581388701</span><span class="p">,</span>
 <span class="s1">&#39;dec_6_loss_rate&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.011046250905098235</span><span class="p">,</span>
 <span class="s1">&#39;dec_7_loss_rate&#39;</span><span class="p">:</span> <span class="mf">0.017228650364514753</span><span class="p">,</span>
 <span class="s1">&#39;dec_8_loss_rate&#39;</span><span class="p">:</span> <span class="mf">0.063195268137886118</span><span class="p">,</span>
 <span class="s1">&#39;dec_9_loss_rate&#39;</span><span class="p">:</span> <span class="mf">0.16077452197707129</span><span class="p">}</span>
</pre></div>
</div>
<p>If we run the national model forwards with these parameters, we see
generally good behavior, except for the 0-9yr demographic bracket, from
whom we expect less self-control. (And because we don&#8217;t have births
data.)</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">country_level_fit_params</span><span class="p">,</span>
          <span class="n">return_timestamps</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2011</span><span class="p">),</span>
          <span class="n">initial_condition</span><span class="o">=</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">country</span><span class="p">[</span><span class="s1">&#39;2000&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
<img alt="../../_images/Exploring_models_across_geographic_scales_22_0.png" src="../../_images/Exploring_models_across_geographic_scales_22_0.png" />
</div>
<div class="section" id="step-3-make-state-level-predictions">
<h3>Step 3: Make state-level predictions<a class="headerlink" href="#step-3-make-state-level-predictions" title="Permalink to this headline">¶</a></h3>
<p>If we want to look at the variances between the states and the national
level, we can try making state-level predictions using state-specific
initial conditions, but parameters fit at the national level.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">states</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">states</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="9" halign="left">2000</th>
      <th colspan="9" halign="left">2010</th>
    </tr>
    <tr>
      <th></th>
      <th>dec_1</th>
      <th>dec_2</th>
      <th>dec_3</th>
      <th>dec_4</th>
      <th>dec_5</th>
      <th>dec_6</th>
      <th>dec_7</th>
      <th>dec_8</th>
      <th>dec_9</th>
      <th>dec_1</th>
      <th>dec_2</th>
      <th>dec_3</th>
      <th>dec_4</th>
      <th>dec_5</th>
      <th>dec_6</th>
      <th>dec_7</th>
      <th>dec_8</th>
      <th>dec_9</th>
    </tr>
    <tr>
      <th>state</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>312841</td>
      <td>329043</td>
      <td>301076</td>
      <td>315262</td>
      <td>321447</td>
      <td>246427</td>
      <td>165327</td>
      <td>109918</td>
      <td>45131</td>
      <td>312605</td>
      <td>338568</td>
      <td>321236</td>
      <td>297502</td>
      <td>321810</td>
      <td>318358</td>
      <td>229496</td>
      <td>124070</td>
      <td>56543</td>
    </tr>
    <tr>
      <th>2</th>
      <td>50687</td>
      <td>53992</td>
      <td>42537</td>
      <td>51442</td>
      <td>56047</td>
      <td>35804</td>
      <td>14974</td>
      <td>7628</td>
      <td>2325</td>
      <td>53034</td>
      <td>52278</td>
      <td>58166</td>
      <td>47753</td>
      <td>51856</td>
      <td>54170</td>
      <td>29869</td>
      <td>10392</td>
      <td>4151</td>
    </tr>
    <tr>
      <th>4</th>
      <td>395110</td>
      <td>384672</td>
      <td>386486</td>
      <td>391330</td>
      <td>352471</td>
      <td>257798</td>
      <td>187193</td>
      <td>144837</td>
      <td>61148</td>
      <td>463808</td>
      <td>466275</td>
      <td>455170</td>
      <td>422447</td>
      <td>418398</td>
      <td>381076</td>
      <td>300553</td>
      <td>178849</td>
      <td>89247</td>
    </tr>
    <tr>
      <th>5</th>
      <td>188589</td>
      <td>201405</td>
      <td>180801</td>
      <td>187516</td>
      <td>186931</td>
      <td>149142</td>
      <td>104621</td>
      <td>72629</td>
      <td>33050</td>
      <td>201821</td>
      <td>205074</td>
      <td>196956</td>
      <td>183761</td>
      <td>192596</td>
      <td>188081</td>
      <td>143285</td>
      <td>81138</td>
      <td>38925</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2669364</td>
      <td>2588761</td>
      <td>2556975</td>
      <td>2812648</td>
      <td>2495158</td>
      <td>1692007</td>
      <td>1002881</td>
      <td>725610</td>
      <td>331342</td>
      <td>2573619</td>
      <td>2780997</td>
      <td>2849483</td>
      <td>2595717</td>
      <td>2655307</td>
      <td>2336519</td>
      <td>1489395</td>
      <td>780576</td>
      <td>456217</td>
    </tr>
  </tbody>
</table>
</div><p>We can now generate a prediction by setting the model&#8217;s intitial
conditions with state level data, and parameters fit in the national
case. I&#8217;ve created a <code class="docutils literal"><span class="pre">model_runner</span></code> helper function to make the code
easier to read, but this could be conducted in a single line if we so
chose.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_runner</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">country_level_fit_params</span><span class="p">,</span>
                       <span class="n">initial_condition</span><span class="o">=</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;2000&#39;</span><span class="p">]),</span>
                       <span class="n">return_timestamps</span><span class="o">=</span><span class="mi">2010</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2010</span><span class="p">]</span>

<span class="n">state_predictions</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">model_runner</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">state_predictions</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dec_1</th>
      <th>dec_2</th>
      <th>dec_3</th>
      <th>dec_4</th>
      <th>dec_5</th>
      <th>dec_6</th>
      <th>dec_7</th>
      <th>dec_8</th>
      <th>dec_9</th>
    </tr>
    <tr>
      <th>state</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>93117.371881</td>
      <td>341167.213342</td>
      <td>337071.875334</td>
      <td>304311.201330</td>
      <td>325833.277920</td>
      <td>316445.464900</td>
      <td>223627.149408</td>
      <td>121168.476612</td>
      <td>65739.525962</td>
    </tr>
    <tr>
      <th>2</th>
      <td>15087.025659</td>
      <td>55697.612356</td>
      <td>52613.730625</td>
      <td>47359.482364</td>
      <td>53391.883377</td>
      <td>50862.893499</td>
      <td>31762.129879</td>
      <td>14297.875847</td>
      <td>6133.949764</td>
    </tr>
    <tr>
      <th>4</th>
      <td>117604.805785</td>
      <td>411745.021973</td>
      <td>413024.709292</td>
      <td>377589.072369</td>
      <td>386843.833461</td>
      <td>354697.832262</td>
      <td>246306.408711</td>
      <td>138031.543558</td>
      <td>79499.152922</td>
    </tr>
    <tr>
      <th>5</th>
      <td>56133.665931</td>
      <td>207553.388634</td>
      <td>204417.938099</td>
      <td>183004.303895</td>
      <td>192875.524445</td>
      <td>187772.888790</td>
      <td>135135.556656</td>
      <td>75209.777699</td>
      <td>42570.643627</td>
    </tr>
    <tr>
      <th>6</th>
      <td>794538.317812</td>
      <td>2775504.193632</td>
      <td>2765302.000982</td>
      <td>2586476.416275</td>
      <td>2709538.756509</td>
      <td>2450307.128284</td>
      <td>1595568.711162</td>
      <td>818892.701581</td>
      <td>439955.979351</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="step-4-compare-model-predictions-with-measured-data">
<h3>Step 4: Compare model predictions with measured data<a class="headerlink" href="#step-4-compare-model-predictions-with-measured-data" title="Permalink to this headline">¶</a></h3>
<p>Comparing the state level predictions with the actual data, we can see
where our model most under or overpredicts population for each
region/cohort combination.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">diff</span> <span class="o">=</span> <span class="n">state_predictions</span><span class="o">-</span><span class="n">states</span><span class="p">[</span><span class="s1">&#39;2010&#39;</span><span class="p">]</span>
<span class="n">diff</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dec_1</th>
      <th>dec_2</th>
      <th>dec_3</th>
      <th>dec_4</th>
      <th>dec_5</th>
      <th>dec_6</th>
      <th>dec_7</th>
      <th>dec_8</th>
      <th>dec_9</th>
    </tr>
    <tr>
      <th>state</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-219487.628119</td>
      <td>2599.213342</td>
      <td>15835.875334</td>
      <td>6809.201330</td>
      <td>4023.277920</td>
      <td>-1912.535100</td>
      <td>-5868.850592</td>
      <td>-2901.523388</td>
      <td>9196.525962</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-37946.974341</td>
      <td>3419.612356</td>
      <td>-5552.269375</td>
      <td>-393.517636</td>
      <td>1535.883377</td>
      <td>-3307.106501</td>
      <td>1893.129879</td>
      <td>3905.875847</td>
      <td>1982.949764</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-346203.194215</td>
      <td>-54529.978027</td>
      <td>-42145.290708</td>
      <td>-44857.927631</td>
      <td>-31554.166539</td>
      <td>-26378.167738</td>
      <td>-54246.591289</td>
      <td>-40817.456442</td>
      <td>-9747.847078</td>
    </tr>
    <tr>
      <th>5</th>
      <td>-145687.334069</td>
      <td>2479.388634</td>
      <td>7461.938099</td>
      <td>-756.696105</td>
      <td>279.524445</td>
      <td>-308.111210</td>
      <td>-8149.443344</td>
      <td>-5928.222301</td>
      <td>3645.643627</td>
    </tr>
    <tr>
      <th>6</th>
      <td>-1779080.682188</td>
      <td>-5492.806368</td>
      <td>-84180.999018</td>
      <td>-9240.583725</td>
      <td>54231.756509</td>
      <td>113788.128284</td>
      <td>106173.711162</td>
      <td>38316.701581</td>
      <td>-16261.020649</td>
    </tr>
  </tbody>
</table>
</div><p>This is a little easier to understand if we weight it by the actual
measured population:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">diff_percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">state_predictions</span><span class="o">-</span><span class="n">states</span><span class="p">[</span><span class="s1">&#39;2010&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">states</span><span class="p">[</span><span class="s1">&#39;2010&#39;</span><span class="p">]</span>
<span class="n">diff_percent</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dec_1</th>
      <th>dec_2</th>
      <th>dec_3</th>
      <th>dec_4</th>
      <th>dec_5</th>
      <th>dec_6</th>
      <th>dec_7</th>
      <th>dec_8</th>
      <th>dec_9</th>
    </tr>
    <tr>
      <th>state</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-0.702124</td>
      <td>0.007677</td>
      <td>0.049297</td>
      <td>0.022888</td>
      <td>0.012502</td>
      <td>-0.006007</td>
      <td>-0.025573</td>
      <td>-0.023386</td>
      <td>0.162647</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.715522</td>
      <td>0.065412</td>
      <td>-0.095456</td>
      <td>-0.008241</td>
      <td>0.029618</td>
      <td>-0.061051</td>
      <td>0.063381</td>
      <td>0.375854</td>
      <td>0.477704</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.746436</td>
      <td>-0.116948</td>
      <td>-0.092592</td>
      <td>-0.106186</td>
      <td>-0.075417</td>
      <td>-0.069220</td>
      <td>-0.180489</td>
      <td>-0.228223</td>
      <td>-0.109223</td>
    </tr>
    <tr>
      <th>5</th>
      <td>-0.721864</td>
      <td>0.012090</td>
      <td>0.037886</td>
      <td>-0.004118</td>
      <td>0.001451</td>
      <td>-0.001638</td>
      <td>-0.056876</td>
      <td>-0.073063</td>
      <td>0.093658</td>
    </tr>
    <tr>
      <th>6</th>
      <td>-0.691276</td>
      <td>-0.001975</td>
      <td>-0.029543</td>
      <td>-0.003560</td>
      <td>0.020424</td>
      <td>0.048700</td>
      <td>0.071286</td>
      <td>0.049088</td>
      <td>-0.035643</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="step-5-merge-with-geo-data-to-plot">
<h3>Step 5: Merge with geo data to plot<a class="headerlink" href="#step-5-merge-with-geo-data-to-plot" title="Permalink to this headline">¶</a></h3>
<p>I&#8217;m using geopandas to manage the shapefiles, and it has its own
plotting functionality. Unfortunately, it is not a particularly well
defined functionality.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">geo_diff</span> <span class="o">=</span> <span class="n">state_geo</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">diff_percent</span><span class="p">)</span>
<span class="n">geo_diff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;dec_4&#39;</span><span class="p">)</span>
<span class="n">geo_diff</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CensusDiv</th>
      <th>CensusReg</th>
      <th>FIPS</th>
      <th>FIPSNum</th>
      <th>Notes</th>
      <th>OBJECTID</th>
      <th>StateFIPS</th>
      <th>StateName</th>
      <th>XCentroid</th>
      <th>YCentroid</th>
      <th>geometry</th>
      <th>dec_1</th>
      <th>dec_2</th>
      <th>dec_3</th>
      <th>dec_4</th>
      <th>dec_5</th>
      <th>dec_6</th>
      <th>dec_7</th>
      <th>dec_8</th>
      <th>dec_9</th>
    </tr>
    <tr>
      <th>StateFIPSN</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>Pacific</td>
      <td>West</td>
      <td>02000</td>
      <td>2000</td>
      <td>None</td>
      <td>1</td>
      <td>02</td>
      <td>Alaska</td>
      <td>-1882092.151950</td>
      <td>2310348.392810</td>
      <td>(POLYGON ((-2247528.774479387 2237995.01157197...</td>
      <td>-0.715522</td>
      <td>0.065412</td>
      <td>-0.095456</td>
      <td>-0.008241</td>
      <td>0.029618</td>
      <td>-0.061051</td>
      <td>0.063381</td>
      <td>0.375854</td>
      <td>0.477704</td>
    </tr>
    <tr>
      <th>53</th>
      <td>Pacific</td>
      <td>West</td>
      <td>53000</td>
      <td>53000</td>
      <td>None</td>
      <td>9</td>
      <td>53</td>
      <td>Washington</td>
      <td>-1837353.153170</td>
      <td>1340481.223852</td>
      <td>(POLYGON ((-2124362.24278068 1480441.850674443...</td>
      <td>-0.718560</td>
      <td>-0.006548</td>
      <td>-0.058893</td>
      <td>-0.069401</td>
      <td>-0.018494</td>
      <td>-0.031807</td>
      <td>-0.047478</td>
      <td>0.013500</td>
      <td>-0.030573</td>
    </tr>
    <tr>
      <th>23</th>
      <td>New England</td>
      <td>Northeast</td>
      <td>23000</td>
      <td>23000</td>
      <td>None</td>
      <td>10</td>
      <td>23</td>
      <td>Maine</td>
      <td>2068849.532637</td>
      <td>1172786.748295</td>
      <td>(POLYGON ((1951177.135094963 1127914.539498126...</td>
      <td>-0.682708</td>
      <td>0.073037</td>
      <td>0.147467</td>
      <td>0.085983</td>
      <td>-0.023217</td>
      <td>-0.055249</td>
      <td>-0.076098</td>
      <td>-0.034226</td>
      <td>-0.009394</td>
    </tr>
    <tr>
      <th>27</th>
      <td>West North Central</td>
      <td>Midwest</td>
      <td>27000</td>
      <td>27000</td>
      <td>None</td>
      <td>11</td>
      <td>27</td>
      <td>Minnesota</td>
      <td>131047.575089</td>
      <td>982130.006959</td>
      <td>POLYGON ((-91052.16805501282 1282100.079225723...</td>
      <td>-0.711546</td>
      <td>0.062669</td>
      <td>0.034611</td>
      <td>0.032717</td>
      <td>0.020127</td>
      <td>-0.019902</td>
      <td>0.043175</td>
      <td>0.022524</td>
      <td>-0.060437</td>
    </tr>
    <tr>
      <th>26</th>
      <td>East North Central</td>
      <td>Midwest</td>
      <td>26000</td>
      <td>26000</td>
      <td>None</td>
      <td>18</td>
      <td>26</td>
      <td>Michigan</td>
      <td>842567.889298</td>
      <td>809437.260865</td>
      <td>(POLYGON ((764918.7306621727 786184.882347865,...</td>
      <td>-0.657411</td>
      <td>0.082088</td>
      <td>0.197840</td>
      <td>0.176409</td>
      <td>0.088111</td>
      <td>0.032552</td>
      <td>0.050903</td>
      <td>0.075986</td>
      <td>0.011505</td>
    </tr>
  </tbody>
</table>
</div><img alt="../../_images/Exploring_models_across_geographic_scales_33_1.png" src="../../_images/Exploring_models_across_geographic_scales_33_1.png" />
</div>
</div>
<div class="section" id="recipe-part-b-fit-state-by-state-models">
<h2>Recipe Part B: fit state-by-state models<a class="headerlink" href="#recipe-part-b-fit-state-by-state-models" title="Permalink to this headline">¶</a></h2>
<p>Now lets try optimizing the model&#8217;s parameters specifically to each
state, and comparing with the national picture.</p>
<div class="section" id="step-1-write-the-optimization-functions-to-account-for-the-state">
<h3>Step 1: Write the optimization functions to account for the state<a class="headerlink" href="#step-1-write-the-optimization-functions-to-account-for-the-state" title="Permalink to this headline">¶</a></h3>
<p>We&#8217;ll start as before with functions that run the model and compute the
error (this time with a parameter for the information about the state in
question) and add a function to optimize and return the best fit
parameters for each state.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">exec_model</span><span class="p">(</span><span class="n">paramlist</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;dec_</span><span class="si">%i</span><span class="s1">_loss_rate&#39;</span><span class="o">%</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)],</span> <span class="n">paramlist</span><span class="p">))</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">initial_condition</span><span class="o">=</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;2000&#39;</span><span class="p">]),</span>
                       <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">return_timestamps</span><span class="o">=</span><span class="mi">2010</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2010</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">paramlist</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">exec_model</span><span class="p">(</span><span class="n">paramlist</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">output</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;2010&#39;</span><span class="p">]</span>
    <span class="c1">#don&#39;t tally errors in the first cohort, as we don&#39;t have info about births</span>
    <span class="n">sse</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sse</span>
</pre></div>
</div>
</div>
<div class="section" id="step-2-apply-optimization-to-each-state">
<h3>Step 2: Apply optimization to each state<a class="headerlink" href="#step-2-apply-optimization-to-each-state" title="Permalink to this headline">¶</a></h3>
<p>We can wrap the optimizer in a function that takes census information
about each state and returns an optimized set of parameters for that
state. If we apply it to the states dataframe, we can get out a similar
dataframe that includes optimized parameters.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">capture</span>
<span class="k">def</span> <span class="nf">optimize_params</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">error</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                                  <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">05</span><span class="p">]</span><span class="o">*</span><span class="mi">9</span><span class="p">,</span>
                                  <span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dec_</span><span class="si">%i</span><span class="s1">_loss_rate&#39;</span><span class="o">%</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)],</span> <span class="n">data</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>

<span class="n">state_fit_params</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">optimize_params</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">state_fit_params</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dec_1_loss_rate</th>
      <th>dec_2_loss_rate</th>
      <th>dec_3_loss_rate</th>
      <th>dec_4_loss_rate</th>
      <th>dec_5_loss_rate</th>
      <th>dec_6_loss_rate</th>
      <th>dec_7_loss_rate</th>
      <th>dec_8_loss_rate</th>
      <th>dec_9_loss_rate</th>
    </tr>
    <tr>
      <th>state</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.021448</td>
      <td>-0.051229</td>
      <td>0.005996</td>
      <td>0.009159</td>
      <td>-0.006314</td>
      <td>-0.012721</td>
      <td>0.013077</td>
      <td>0.061467</td>
      <td>0.199157</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.024790</td>
      <td>-0.045179</td>
      <td>-0.021897</td>
      <td>0.015292</td>
      <td>-0.003120</td>
      <td>-0.023723</td>
      <td>0.039461</td>
      <td>0.137920</td>
      <td>0.200484</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.015650</td>
      <td>-0.066072</td>
      <td>-0.009319</td>
      <td>-0.003544</td>
      <td>-0.012930</td>
      <td>-0.018060</td>
      <td>-0.013545</td>
      <td>0.033047</td>
      <td>0.168508</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.022108</td>
      <td>-0.050841</td>
      <td>0.003923</td>
      <td>0.005605</td>
      <td>-0.006411</td>
      <td>-0.011430</td>
      <td>0.006571</td>
      <td>0.054650</td>
      <td>0.191023</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.020025</td>
      <td>-0.052080</td>
      <td>-0.006135</td>
      <td>0.010332</td>
      <td>-0.004042</td>
      <td>-0.004572</td>
      <td>0.025891</td>
      <td>0.065019</td>
      <td>0.148008</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="step-3-merge-with-geographic-data">
<h3>Step 3: Merge with geographic data<a class="headerlink" href="#step-3-merge-with-geographic-data" title="Permalink to this headline">¶</a></h3>
<p>As we&#8217;re looking at model parameters which themselves are multiplied by
populations to generate actual flows of people, we can look at the
difference between parameters directly without needing to normalize.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">geo_diff</span> <span class="o">=</span> <span class="n">state_geo</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">state_fit_params</span><span class="p">)</span>
<span class="n">geo_diff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;dec_4_loss_rate&#39;</span><span class="p">)</span>
<span class="n">geo_diff</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CensusDiv</th>
      <th>CensusReg</th>
      <th>FIPS</th>
      <th>FIPSNum</th>
      <th>Notes</th>
      <th>OBJECTID</th>
      <th>StateFIPS</th>
      <th>StateName</th>
      <th>XCentroid</th>
      <th>YCentroid</th>
      <th>geometry</th>
      <th>dec_1_loss_rate</th>
      <th>dec_2_loss_rate</th>
      <th>dec_3_loss_rate</th>
      <th>dec_4_loss_rate</th>
      <th>dec_5_loss_rate</th>
      <th>dec_6_loss_rate</th>
      <th>dec_7_loss_rate</th>
      <th>dec_8_loss_rate</th>
      <th>dec_9_loss_rate</th>
    </tr>
    <tr>
      <th>StateFIPSN</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>Pacific</td>
      <td>West</td>
      <td>02000</td>
      <td>2000</td>
      <td>None</td>
      <td>1</td>
      <td>02</td>
      <td>Alaska</td>
      <td>-1882092.151950</td>
      <td>2310348.392810</td>
      <td>(POLYGON ((-2247528.774479387 2237995.01157197...</td>
      <td>0.024790</td>
      <td>-0.045179</td>
      <td>-0.021897</td>
      <td>0.015292</td>
      <td>-0.003120</td>
      <td>-0.023723</td>
      <td>0.039461</td>
      <td>0.137920</td>
      <td>0.200484</td>
    </tr>
    <tr>
      <th>53</th>
      <td>Pacific</td>
      <td>West</td>
      <td>53000</td>
      <td>53000</td>
      <td>None</td>
      <td>9</td>
      <td>53</td>
      <td>Washington</td>
      <td>-1837353.153170</td>
      <td>1340481.223852</td>
      <td>(POLYGON ((-2124362.24278068 1480441.850674443...</td>
      <td>0.021844</td>
      <td>-0.053040</td>
      <td>-0.010785</td>
      <td>0.001392</td>
      <td>-0.006107</td>
      <td>-0.015620</td>
      <td>0.010874</td>
      <td>0.072777</td>
      <td>0.150871</td>
    </tr>
    <tr>
      <th>23</th>
      <td>New England</td>
      <td>Northeast</td>
      <td>23000</td>
      <td>23000</td>
      <td>None</td>
      <td>10</td>
      <td>23</td>
      <td>Maine</td>
      <td>2068849.532637</td>
      <td>1172786.748295</td>
      <td>(POLYGON ((1951177.135094963 1127914.539498126...</td>
      <td>0.025517</td>
      <td>-0.044513</td>
      <td>0.016994</td>
      <td>0.013372</td>
      <td>-0.014052</td>
      <td>-0.017986</td>
      <td>0.007721</td>
      <td>0.065287</td>
      <td>0.161693</td>
    </tr>
  </tbody>
</table>
</div><img alt="../../_images/Exploring_models_across_geographic_scales_39_1.png" src="../../_images/Exploring_models_across_geographic_scales_39_1.png" />
</div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../surrogating_functions/index_surrogate.html" class="btn btn-neutral float-right" title="Surrogating Functions">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Doing_more_with_spatialdata_multi_regional_SIR_Model.html" class="btn btn-neutral" title="Installation"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, James Houghton.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>